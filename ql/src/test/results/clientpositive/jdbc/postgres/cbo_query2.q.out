CTE Suggestion:
JdbcAggregate(group=[{0}], agg#0=[sum($1)], agg#1=[sum($2)], agg#2=[sum($3)], agg#3=[sum($4)], agg#4=[sum($5)], agg#5=[sum($6)], agg#6=[sum($7)])
  JdbcProject($f0=[$3], $f1=[CASE($4, $1, null:DECIMAL(7, 2))], $f2=[CASE($5, $1, null:DECIMAL(7, 2))], $f3=[CASE($6, $1, null:DECIMAL(7, 2))], $f4=[CASE($7, $1, null:DECIMAL(7, 2))], $f5=[CASE($8, $1, null:DECIMAL(7, 2))], $f6=[CASE($9, $1, null:DECIMAL(7, 2))], $f7=[CASE($10, $1, null:DECIMAL(7, 2))])
    JdbcJoin(condition=[=($2, $0)], joinType=[inner])
      JdbcUnion(all=[true])
        JdbcFilter(condition=[IS NOT NULL($0)])
          JdbcProject(ws_sold_date_sk=[$0], ws_ext_sales_price=[$23])
            JdbcHiveTableScan(table=[[default, web_sales]], table:alias=[web_sales])
        JdbcFilter(condition=[IS NOT NULL($0)])
          JdbcProject(cs_sold_date_sk=[$0], cs_ext_sales_price=[$23])
            JdbcHiveTableScan(table=[[default, catalog_sales]], table:alias=[catalog_sales])
      JdbcProject(d_date_sk=[$0], d_week_seq=[$1], ==[=($2, _UTF-16LE'Sunday')], =3=[=($2, _UTF-16LE'Monday')], =4=[=($2, _UTF-16LE'Tuesday')], =5=[=($2, _UTF-16LE'Wednesday')], =6=[=($2, _UTF-16LE'Thursday')], =7=[=($2, _UTF-16LE'Friday')], =8=[=($2, _UTF-16LE'Saturday')])
        JdbcFilter(condition=[AND(IS NOT NULL($0), IS NOT NULL($1))])
          JdbcProject(d_date_sk=[$0], d_week_seq=[$4], d_day_name=[$14])
            JdbcHiveTableScan(table=[[default, date_dim]], table:alias=[date_dim])

PREHOOK: query: explain cbo
with wscs as
 (select sold_date_sk
        ,sales_price
  from (select ws_sold_date_sk sold_date_sk
              ,ws_ext_sales_price sales_price
        from web_sales) x
        union all
       (select cs_sold_date_sk sold_date_sk
              ,cs_ext_sales_price sales_price
        from catalog_sales)),
 wswscs as 
 (select d_week_seq,
        sum(case when (d_day_name='Sunday') then sales_price else null end) sun_sales,
        sum(case when (d_day_name='Monday') then sales_price else null end) mon_sales,
        sum(case when (d_day_name='Tuesday') then sales_price else  null end) tue_sales,
        sum(case when (d_day_name='Wednesday') then sales_price else null end) wed_sales,
        sum(case when (d_day_name='Thursday') then sales_price else null end) thu_sales,
        sum(case when (d_day_name='Friday') then sales_price else null end) fri_sales,
        sum(case when (d_day_name='Saturday') then sales_price else null end) sat_sales
 from wscs
     ,date_dim
 where d_date_sk = sold_date_sk
 group by d_week_seq)
 select d_week_seq1
       ,round(sun_sales1/sun_sales2,2)
       ,round(mon_sales1/mon_sales2,2)
       ,round(tue_sales1/tue_sales2,2)
       ,round(wed_sales1/wed_sales2,2)
       ,round(thu_sales1/thu_sales2,2)
       ,round(fri_sales1/fri_sales2,2)
       ,round(sat_sales1/sat_sales2,2)
 from
 (select wswscs.d_week_seq d_week_seq1
        ,sun_sales sun_sales1
        ,mon_sales mon_sales1
        ,tue_sales tue_sales1
        ,wed_sales wed_sales1
        ,thu_sales thu_sales1
        ,fri_sales fri_sales1
        ,sat_sales sat_sales1
  from wswscs,date_dim 
  where date_dim.d_week_seq = wswscs.d_week_seq and
        d_year = 2001) y,
 (select wswscs.d_week_seq d_week_seq2
        ,sun_sales sun_sales2
        ,mon_sales mon_sales2
        ,tue_sales tue_sales2
        ,wed_sales wed_sales2
        ,thu_sales thu_sales2
        ,fri_sales fri_sales2
        ,sat_sales sat_sales2
  from wswscs
      ,date_dim 
  where date_dim.d_week_seq = wswscs.d_week_seq and
        d_year = 2001+1) z
 where d_week_seq1=d_week_seq2-53
 order by d_week_seq1
PREHOOK: type: QUERY
PREHOOK: Input: default@catalog_sales
PREHOOK: Input: default@date_dim
PREHOOK: Input: default@web_sales
#### A masked pattern was here ####
POSTHOOK: query: explain cbo
with wscs as
 (select sold_date_sk
        ,sales_price
  from (select ws_sold_date_sk sold_date_sk
              ,ws_ext_sales_price sales_price
        from web_sales) x
        union all
       (select cs_sold_date_sk sold_date_sk
              ,cs_ext_sales_price sales_price
        from catalog_sales)),
 wswscs as 
 (select d_week_seq,
        sum(case when (d_day_name='Sunday') then sales_price else null end) sun_sales,
        sum(case when (d_day_name='Monday') then sales_price else null end) mon_sales,
        sum(case when (d_day_name='Tuesday') then sales_price else  null end) tue_sales,
        sum(case when (d_day_name='Wednesday') then sales_price else null end) wed_sales,
        sum(case when (d_day_name='Thursday') then sales_price else null end) thu_sales,
        sum(case when (d_day_name='Friday') then sales_price else null end) fri_sales,
        sum(case when (d_day_name='Saturday') then sales_price else null end) sat_sales
 from wscs
     ,date_dim
 where d_date_sk = sold_date_sk
 group by d_week_seq)
 select d_week_seq1
       ,round(sun_sales1/sun_sales2,2)
       ,round(mon_sales1/mon_sales2,2)
       ,round(tue_sales1/tue_sales2,2)
       ,round(wed_sales1/wed_sales2,2)
       ,round(thu_sales1/thu_sales2,2)
       ,round(fri_sales1/fri_sales2,2)
       ,round(sat_sales1/sat_sales2,2)
 from
 (select wswscs.d_week_seq d_week_seq1
        ,sun_sales sun_sales1
        ,mon_sales mon_sales1
        ,tue_sales tue_sales1
        ,wed_sales wed_sales1
        ,thu_sales thu_sales1
        ,fri_sales fri_sales1
        ,sat_sales sat_sales1
  from wswscs,date_dim 
  where date_dim.d_week_seq = wswscs.d_week_seq and
        d_year = 2001) y,
 (select wswscs.d_week_seq d_week_seq2
        ,sun_sales sun_sales2
        ,mon_sales mon_sales2
        ,tue_sales tue_sales2
        ,wed_sales wed_sales2
        ,thu_sales thu_sales2
        ,fri_sales fri_sales2
        ,sat_sales sat_sales2
  from wswscs
      ,date_dim 
  where date_dim.d_week_seq = wswscs.d_week_seq and
        d_year = 2001+1) z
 where d_week_seq1=d_week_seq2-53
 order by d_week_seq1
POSTHOOK: type: QUERY
POSTHOOK: Input: default@catalog_sales
POSTHOOK: Input: default@date_dim
POSTHOOK: Input: default@web_sales
#### A masked pattern was here ####
CBO PLAN:
HiveSortLimit(sort0=[$0], dir0=[ASC])
  HiveProject(d_week_seq1=[$0], _o__c1=[round(/($1, $10), 2)], _o__c2=[round(/($2, $11), 2)], _o__c3=[round(/($3, $12), 2)], _o__c4=[round(/($4, $13), 2)], _o__c5=[round(/($5, $14), 2)], _o__c6=[round(/($6, $15), 2)], _o__c7=[round(/($7, $16), 2)])
    HiveProject($f0=[$0], $f1=[$1], $f2=[$2], $f3=[$3], $f4=[$4], $f5=[$5], $f6=[$6], $f7=[$7], d_week_seq=[$8], $f00=[$9], $f10=[$10], $f20=[$11], $f30=[$12], $f40=[$13], $f50=[$14], $f60=[$15], $f70=[$16], d_week_seq0=[$17])
      HiveJdbcConverter(convention=[JDBC.POSTGRES])
        JdbcJoin(condition=[=($0, -($9, 53))], joinType=[inner])
          JdbcJoin(condition=[=($8, $0)], joinType=[inner])
            JdbcAggregate(group=[{0}], agg#0=[sum($1)], agg#1=[sum($2)], agg#2=[sum($3)], agg#3=[sum($4)], agg#4=[sum($5)], agg#5=[sum($6)], agg#6=[sum($7)])
              JdbcProject($f0=[$3], $f1=[CASE($4, $1, null:DECIMAL(7, 2))], $f2=[CASE($5, $1, null:DECIMAL(7, 2))], $f3=[CASE($6, $1, null:DECIMAL(7, 2))], $f4=[CASE($7, $1, null:DECIMAL(7, 2))], $f5=[CASE($8, $1, null:DECIMAL(7, 2))], $f6=[CASE($9, $1, null:DECIMAL(7, 2))], $f7=[CASE($10, $1, null:DECIMAL(7, 2))])
                JdbcJoin(condition=[=($2, $0)], joinType=[inner])
                  JdbcProject(ws_sold_date_sk=[$0], ws_ext_sales_price=[$1])
                    JdbcUnion(all=[true])
                      JdbcProject(ws_sold_date_sk=[$0], ws_ext_sales_price=[$1])
                        JdbcFilter(condition=[IS NOT NULL($0)])
                          JdbcProject(ws_sold_date_sk=[$0], ws_ext_sales_price=[$23])
                            JdbcHiveTableScan(table=[[default, web_sales]], table:alias=[web_sales])
                      JdbcProject(cs_sold_date_sk=[$0], cs_ext_sales_price=[$1])
                        JdbcFilter(condition=[IS NOT NULL($0)])
                          JdbcProject(cs_sold_date_sk=[$0], cs_ext_sales_price=[$23])
                            JdbcHiveTableScan(table=[[default, catalog_sales]], table:alias=[catalog_sales])
                  JdbcProject(d_date_sk=[$0], d_week_seq=[$1], ==[=($2, _UTF-16LE'Sunday')], =3=[=($2, _UTF-16LE'Monday')], =4=[=($2, _UTF-16LE'Tuesday')], =5=[=($2, _UTF-16LE'Wednesday')], =6=[=($2, _UTF-16LE'Thursday')], =7=[=($2, _UTF-16LE'Friday')], =8=[=($2, _UTF-16LE'Saturday')])
                    JdbcFilter(condition=[AND(IS NOT NULL($0), IS NOT NULL($1))])
                      JdbcProject(d_date_sk=[$0], d_week_seq=[$4], d_day_name=[$14])
                        JdbcHiveTableScan(table=[[default, date_dim]], table:alias=[date_dim])
            JdbcProject(d_week_seq=[$0])
              JdbcFilter(condition=[AND(=($1, 2001), IS NOT NULL($0))])
                JdbcProject(d_week_seq=[$4], d_year=[$6])
                  JdbcHiveTableScan(table=[[default, date_dim]], table:alias=[date_dim])
          JdbcProject($f0=[$0], $f1=[$1], $f2=[$2], $f3=[$3], $f4=[$4], $f5=[$5], $f6=[$6], $f7=[$7], d_week_seq=[$8])
            JdbcJoin(condition=[=($8, $0)], joinType=[inner])
              JdbcAggregate(group=[{0}], agg#0=[sum($1)], agg#1=[sum($2)], agg#2=[sum($3)], agg#3=[sum($4)], agg#4=[sum($5)], agg#5=[sum($6)], agg#6=[sum($7)])
                JdbcProject($f0=[$3], $f1=[CASE($4, $1, null:DECIMAL(7, 2))], $f2=[CASE($5, $1, null:DECIMAL(7, 2))], $f3=[CASE($6, $1, null:DECIMAL(7, 2))], $f4=[CASE($7, $1, null:DECIMAL(7, 2))], $f5=[CASE($8, $1, null:DECIMAL(7, 2))], $f6=[CASE($9, $1, null:DECIMAL(7, 2))], $f7=[CASE($10, $1, null:DECIMAL(7, 2))])
                  JdbcJoin(condition=[=($2, $0)], joinType=[inner])
                    JdbcProject(ws_sold_date_sk=[$0], ws_ext_sales_price=[$1])
                      JdbcUnion(all=[true])
                        JdbcProject(ws_sold_date_sk=[$0], ws_ext_sales_price=[$1])
                          JdbcFilter(condition=[IS NOT NULL($0)])
                            JdbcProject(ws_sold_date_sk=[$0], ws_ext_sales_price=[$23])
                              JdbcHiveTableScan(table=[[default, web_sales]], table:alias=[web_sales])
                        JdbcProject(cs_sold_date_sk=[$0], cs_ext_sales_price=[$1])
                          JdbcFilter(condition=[IS NOT NULL($0)])
                            JdbcProject(cs_sold_date_sk=[$0], cs_ext_sales_price=[$23])
                              JdbcHiveTableScan(table=[[default, catalog_sales]], table:alias=[catalog_sales])
                    JdbcProject(d_date_sk=[$0], d_week_seq=[$1], ==[=($2, _UTF-16LE'Sunday')], =3=[=($2, _UTF-16LE'Monday')], =4=[=($2, _UTF-16LE'Tuesday')], =5=[=($2, _UTF-16LE'Wednesday')], =6=[=($2, _UTF-16LE'Thursday')], =7=[=($2, _UTF-16LE'Friday')], =8=[=($2, _UTF-16LE'Saturday')])
                      JdbcFilter(condition=[AND(IS NOT NULL($0), IS NOT NULL($1))])
                        JdbcProject(d_date_sk=[$0], d_week_seq=[$4], d_day_name=[$14])
                          JdbcHiveTableScan(table=[[default, date_dim]], table:alias=[date_dim])
              JdbcProject(d_week_seq=[$0])
                JdbcFilter(condition=[AND(=($1, 2002), IS NOT NULL($0))])
                  JdbcProject(d_week_seq=[$4], d_year=[$6])
                    JdbcHiveTableScan(table=[[default, date_dim]], table:alias=[date_dim])

